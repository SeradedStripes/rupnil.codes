<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Rupnil.Codes — Dashboard</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="modulepreload" href="/script.js">
  <link rel="modulepreload" href="/firebase/auth.js">
  <link rel="modulepreload" href="/firebase/db.js">
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
</head>

<body>
  <div id="site-header"></div>
  <script type="module" src="/script.js"></script>

  <main class="section">
    <div>
      <h1>Dashboard</h1> <br>
        <span style="color:#bbb; margin-right:1rem;">Signed in as <strong id="user-email">—</strong></span> <br>
        <button id="signout-btn">Sign out</button>
    </div>

    <section class="section">
      <div class="cards">
        <a href="#"><div class="card">
          <h3>Your Projects</h3>
        </div> </a>
        <a href="settings.html"><div class="card">
          <h3>Open Settings</h3>
        </div> </a>
      </div>
    </section>
  </main>

  <script type="module">
    (async () => {
      const [authMod, dbMod] = await Promise.all([
        import('/firebase/auth.js'),
        import('/firebase/db.js')
      ]);

      const { signOutUser, onAuthState } = authMod;
      const { requestAlias, checkAliasStatus, ensureUserDoc } = dbMod;

      const emailEl = document.getElementById('user-email');
      const signoutBtn = document.getElementById('signout-btn');

      const aliasInput = document.getElementById('alias-input');
      const aliasRequestBtn = document.getElementById('alias-request-btn');
      const aliasCheckBtn = document.getElementById('alias-check-btn');
      const aliasStatusEl = document.getElementById('alias-status');

      onAuthState((user) => {
        if (!user) {
          window.location.href = '/account/login.html';
        } else {
          emailEl.textContent = user.email || 'User';
          // ensure the user record exists in Firestore (non-blocking)
          ensureUserDoc(user).catch(err => console.error('ensureUserDoc failed:', err));
        }
      });

      signoutBtn.addEventListener('click', async () => {
        try {
          await signOutUser();
          window.location.href = '/';
        } catch (err) {
          alert('Sign out failed: ' + (err.message || err));
        }
      });

      if (aliasRequestBtn) aliasRequestBtn.addEventListener('click', async () => {
        const alias = aliasInput.value.trim();
        if (!alias) return alert('Please enter an alias');
        aliasRequestBtn.disabled = true;
        try {
          await requestAlias(alias);
          alert('Alias request sent!');
          aliasStatusEl.textContent = 'pending';
        } catch (err) {
          alert('Failed to request alias: ' + (err.message || err));
        } finally {
          aliasRequestBtn.disabled = false;
        }
      });

      if (aliasCheckBtn) aliasCheckBtn.addEventListener('click', async () => {
        const alias = aliasInput.value.trim();
        if (!alias) return alert('Please enter an alias');
        aliasCheckBtn.disabled = true;
        try {
          const status = await checkAliasStatus(alias);
          aliasStatusEl.textContent = status || 'not found';
        } catch (err) {
          alert('Failed to check status: ' + (err.message || err));
        } finally {
          aliasCheckBtn.disabled = false;
        }
      });
    })();
  </script>

  <div id="site-footer"></div>
</body>
</html>
