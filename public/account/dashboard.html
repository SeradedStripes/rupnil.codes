<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Rupnil.Codes — Dashboard</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="modulepreload" href="/script.js">
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
</head>
<body>
  <div id="site-header"></div>
  <script>
    if (!window.API_BASE && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      window.API_BASE = 'https://api.rupnil.codes';
    }
  </script>
  <script type="module" src="/script.js"></script>

  <main class="section">
    <div>
      <h1>Dashboard</h1> <br>
        <span style="color:#bbb; margin-right:1rem;">Signed in as <strong id="user-email">—</strong></span> <br>
        <button id="signout-btn">Sign out</button>
    </div>

    <section class="section">
      <div class="cards">
        <a href="#"><div class="card">
          <h3>Your Projects</h3>
        </div> </a>
        <a href="settings.html"><div class="card">
          <h3>Open Settings</h3>
        </div> </a>
      </div>
    </section>
  </main>

  <script type="module">
    (async () => {
      const { getJwt, getRefreshToken, clearTokens, apiFetch } = await import('/assets/hca.js');

      const emailEl = document.getElementById('user-email');
      const signoutBtn = document.getElementById('signout-btn');

      async function loadUser() {
        const jwt = getJwt();
        if (!jwt) return window.location.href = '/account/login.html';
        try {
          const me = await apiFetch('/me');
          emailEl.textContent = me.email || 'User';
        } catch (err) {
          console.error('Failed to fetch /me:', err);
          clearTokens();
          window.location.href = '/account/login.html';
        }
      }

      loadUser();

      signoutBtn.addEventListener('click', async () => {
        try {
          const rt = getRefreshToken();
          if (rt) {
            await fetch('/auth/logout', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ refresh_token: rt }) });
          }
        } catch (err) {
          console.error('Logout failed:', err);
        } finally {
          clearTokens();
          window.location.href = '/';
        }
      });

    })();
  </script>

  <div id="site-footer"></div>
</body>
</html>
