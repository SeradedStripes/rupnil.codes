<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Rupnil.Codes — Dashboard</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
  <div id="site-header"></div>
  <script type="module" src="/script.js"></script>

  <main class="section">
    <div>
      <h1>Dashboard</h1> <br>
        <span style="color:#bbb; margin-right:1rem;">Signed in as <strong id="user-email">—</strong></span> <br>
        <button id="signout-btn">Sign out</button>
    </div>

    <section class="section" aria-labelledby="overview-heading">
      <div class="cards">
        <div class="card">
          <h3>Profile</h3>
          <p>display profile info here.</p>
          <p><a href="#">Edit profile</a></p>
        </div>
        <div class="card">
          <h3>Projects</h3>
          <p>list of your projects will appear here.</p>
          <p><a href="#">View projects</a></p>
        </div>
      </div>
      <div class="cards">
        <div class="card">
          <h3>Settings</h3>
          <p>account settings and preferences.</p>
          <p><a href="#">Open settings</a></p>
        </div>
        <div class="card">
          <h3>Activity</h3>
          <p>recent activity feed.</p>
          <p><a href="#">View activity</a></p>
        </div>
        <div class="card" id="alias-card">
          <h3>Alias</h3>
          <p>Request a public alias for your profile.</p>
          <p>
            <input id="alias-input" placeholder="desired-alias" />
            <button id="alias-request-btn">Request Alias</button>
            <button id="alias-check-btn">Check Status</button>
          </p>
          <p>Status: <span id="alias-status">—</span></p>
        </div>
      </div>
    </section>

    <section class="section" aria-labelledby="extras-heading">
      <h2 id="extras-heading">Extras</h2>
      <ul>
        <li>Placeholder: Invitations</li>
        <li>Placeholder: Subscription / Billing</li>
        <li>Placeholder: Help & Support</li>
      </ul>
    </section>
  </main>

  <script type="module">
    import { signOutUser, onAuthState, requestAlias, checkAliasStatus, ensureUserDoc } from '/firebase.js';

    const emailEl = document.getElementById('user-email');
    const signoutBtn = document.getElementById('signout-btn');

    const aliasInput = document.getElementById('alias-input');
    const aliasRequestBtn = document.getElementById('alias-request-btn');
    const aliasCheckBtn = document.getElementById('alias-check-btn');
    const aliasStatusEl = document.getElementById('alias-status');

    onAuthState((user) => {
      if (!user) {
        window.location.href = '/account/login.html';
      } else {
        emailEl.textContent = user.email || 'User';
        // ensure the user record exists in Firestore (non-blocking)
        ensureUserDoc(user).catch(err => console.error('ensureUserDoc failed:', err));
      }
    });

    signoutBtn.addEventListener('click', async () => {
      try {
        await signOutUser();
        window.location.href = '/';
      } catch (err) {
        alert('Sign out failed: ' + (err.message || err));
      }
    });

    aliasRequestBtn.addEventListener('click', async () => {
      const alias = aliasInput.value.trim();
      if (!alias) return alert('Please enter an alias');
      aliasRequestBtn.disabled = true;
      try {
        await requestAlias(alias);
        alert('Alias request sent!');
        aliasStatusEl.textContent = 'pending';
      } catch (err) {
        alert('Failed to request alias: ' + (err.message || err));
      } finally {
        aliasRequestBtn.disabled = false;
      }
    });

    aliasCheckBtn.addEventListener('click', async () => {
      const alias = aliasInput.value.trim();
      if (!alias) return alert('Please enter an alias');
      aliasCheckBtn.disabled = true;
      try {
        const status = await checkAliasStatus(alias);
        aliasStatusEl.textContent = status || 'not found';
      } catch (err) {
        alert('Failed to check status: ' + (err.message || err));
      } finally {
        aliasCheckBtn.disabled = false;
      }
    });
  </script>

  <div id="site-footer"></div>
</body>
</html>
